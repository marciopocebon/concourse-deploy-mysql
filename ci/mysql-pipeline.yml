resources:
- name: concourse-deploy-mysql
  type: git
  check_every: 4h
  source:
    uri: https://github.com/s-matyukevich/concourse-deploy-mysql
    branch: master
- name: mysql-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/cf-mysql-release
- name: vsphere-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-vsphere-esxi-ubuntu-trusty-go_agent
- name: control-plane-mysql
  type: bosh-deployment
  source:
    target: {{control-plane-bosh-url}}
    client_id: {{control-plane-bosh-client-id}}
    client_secret: {{control-plane-bosh-client-secret}}
    ca_cert: {{control-plane-bosh-cacert}}
    deployment: mysql
- name: scdc1-mysql
  type: bosh-deployment
  source:
    target: {{scdc1-bosh-url}}
    client_id: {{scdc1-bosh-client-id}}
    client_secret: {{scdc1-bosh-client-secret}}
    ca_cert: {{scdc1-bosh-cacert}}
    deployment: mysql
- name: wdc1-mysql
  type: bosh-deployment
  source:
    target: {{wdc1-bosh-url}}
    client_id: {{wdc1-bosh-client-id}}
    client_secret: {{wdc1-bosh-client-secret}}
    ca_cert: {{wdc1-bosh-cacert}}
    deployment: mysql

jobs:
- name: deploy-to-control-plane
  plan:
    - aggregate:
      - get: vsphere-stemcell
      - get: mysql-release
      - get: concourse-deploy-mysql
    - task: generate-manifest
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: smatyukevich/bosh-worker
        run:
          path: concourse-deploy-mysql/ci/tasks/generate-manifest.sh concourse-deploy-mysql/ci/manifests/control-plane.yml
        params:
          ARBITRATOR_IP: {{arbitrator-ip}}
          SCDC1_MASTER_IP: {{scdc1-master-ip}}
          WCDC1_MASTER_IP: {{wdc1-master-ip}}
        inputs:
        - name: concourse-deploy-mysql
        outputs:
        - name: manifest
    - put: control-plane-mysql
      params:
        manifest: manifest/manifest.yml
- name: deploy-to-scdc1
  plan:
    - aggregate:
      - get: vsphere-stemcell
      - get: mysql-release
      - get: concourse-deploy-mysql
    - task: generate-manifest
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: smatyukevich/bosh-worker
        run:
          path: concourse-deploy-mysql/ci/tasks/generate-manifest.sh concourse-deploy-mysql/ci/manifests/datacenter.yml
        params:
          ARBITRATOR_IP: {{arbitrator-ip}}
          SCDC1_MASTER_IP: {{scdc1-master-ip}}
          WCDC1_MASTER_IP: {{wdc1-master-ip}}
          MASTER_IP: {{scdc1-master-ip}}
          PROXY_IP: {{scdc1-proxy-ip}}
        inputs:
        - name: concourse-deploy-mysql
        outputs:
        - name: manifest
    - put: scdc1-mysql
      params:
        manifest: manifest/manifest.yml
- name: deploy-to-wdc1
  plan:
    - aggregate:
      - get: vsphere-stemcell
      - get: mysql-release
      - get: concourse-deploy-mysql
    - task: generate-manifest
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: smatyukevich/bosh-worker
        run:
          path: concourse-deploy-mysql/ci/tasks/generate-manifest.sh concourse-deploy-mysql/ci/manifests/datacenter.yml
        params:
          ARBITRATOR_IP: {{arbitrator-ip}}
          SCDC1_MASTER_IP: {{scdc1-master-ip}}
          WCDC1_MASTER_IP: {{wdc1-master-ip}}
          MASTER_IP: {{wdc1-master-ip}}
          PROXY_IP: {{wdc1-proxy-ip}}
        inputs:
        - name: concourse-deploy-mysql
        outputs:
        - name: manifest
    - put: wdc1-mysql
      params:
        manifest: manifest/manifest.yml
- name: bootstrap
  plan:
    - aggregate:
      - get: concourse-deploy-mysql
      - get: control-plane-mysql
        passed: [deploy-to-control-plane]
      - get: scdc1-mysql
        passed: [deploy-to-scdc1]
      - get: wdc1-mysql
        passed: [deploy-to-wdc1]
    - task: bootstrap
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: smatyukevich/bosh-worker
        run:
          path: concourse-deploy-mysql/ci/tasks/run-errand.sh
        params:
          BOSH_CACERT: {{control-plane-bosh-cacert}}
          BOSH_CLIENT: {{control-plane-bosh-client-id}}
          BOSH_CLIENT_SECRET: {{control-plane-bosh-client-secret}}
          BOSH_DEPLOYMENT_NAME: mysql
          BOSH_ERRAND: bootstrap
          BOSH_TARGET: {{control-plane-bosh-url}}
        inputs:
        - name: concourse-deploy-mysql
        outputs:
- name: rejoin-unsafe
  plan:
    - aggregate:
      - get: concourse-deploy-mysql
      - get: control-plane-mysql
        passed: [deploy-to-control-plane]
      - get: scdc1-mysql
        passed: [deploy-to-scdc1]
      - get: wdc1-mysql
        passed: [deploy-to-wdc1]
    - task: rejoin-unsafe
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: smatyukevich/bosh-worker
        run:
          path: concourse-deploy-mysql/ci/tasks/run-errand.sh
        params:
          BOSH_CACERT: {{control-plane-bosh-cacert}}
          BOSH_CLIENT: {{control-plane-bosh-client-id}}
          BOSH_CLIENT_SECRET: {{control-plane-bosh-client-secret}}
          BOSH_DEPLOYMENT_NAME: mysql
          BOSH_ERRAND: rejoin-unsafe
          BOSH_TARGET: {{control-plane-bosh-url}}
        inputs:
        - name: concourse-deploy-mysql
        outputs:
- name: smoke-tests
  plan:
    - aggregate:
      - get: concourse-deploy-mysql
      - get: control-plane-mysql
        passed: [deploy-to-control-plane]
      - get: scdc1-mysql
        passed: [deploy-to-scdc1]
      - get: wdc1-mysql
        passed: [deploy-to-wdc1]
    - task: smoke-tests
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: smatyukevich/bosh-worker
        run:
          path: concourse-deploy-mysql/ci/tasks/run-errand.sh
        params:
          BOSH_CACERT: {{control-plane-bosh-cacert}}
          BOSH_CLIENT: {{control-plane-bosh-client-id}}
          BOSH_CLIENT_SECRET: {{control-plane-bosh-client-secret}}
          BOSH_DEPLOYMENT_NAME: mysql
          BOSH_ERRAND: smoke-tests
          BOSH_TARGET: {{control-plane-bosh-url}}
        inputs:
        - name: concourse-deploy-mysql
        outputs:
